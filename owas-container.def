# This is the main OWAS container image

Bootstrap: docker
From: debian:bookworm

%files
    flow.tcl /usr/local/bin/flow.tcl
    openroad /usr/local/bin/openroad
    openlane /usr/local/bin/openlane
    ghdl /usr/local/bin/ghdl
    spack_owas /spack_owas

%post -c /bin/bash
    chmod +x /usr/local/bin/flow.tcl
    chmod +x /usr/local/bin/openroad
    chmod +x /usr/local/bin/openlane
    chmod +x /usr/local/bin/ghdl

    apt-get update
    apt install -o DPkg::Options::=--force-confold -y wget

    # apptainer for embedded efabless/openlane container, other stuff for spack
    APPTAINER_VERSION=1.4.1
    wget https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer_${APPTAINER_VERSION}_amd64.deb
    wget https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-suid_${APPTAINER_VERSION}_amd64.deb
    apt install -o DPkg::Options::=--force-confold -y \
        ./apptainer_${APPTAINER_VERSION}_amd64.deb \
        ./apptainer-suid_${APPTAINER_VERSION}_amd64.deb
    rm apptainer_${APPTAINER_VERSION}_amd64.deb
    rm apptainer-suid_${APPTAINER_VERSION}_amd64.deb

    # disable setuid for nested containers (by default)
    sed -i 's/^\(allow setuid\s*=\s*\)yes/\1no/' /etc/apptainer/apptainer.conf

    apt install -o DPkg::Options::=--force-confold -y \
        fuse3           \
        curl            \
        git             \
        python3         \
        python3-tk      \
        python3-dev     \
        python3-venv    \
        gcc             \
        g++             \
        g++-11          \
        gfortran        \
        gfortran-11     \
        make            \
        patch           \
        gpg             \
        file            \
        gpg-agent       \
        xz-utils        \
        unzip           \
        bzip2           \
        automake        \
        autoconf        \
        flex            \
        bison           \
        pkgconf         \
        zlib1g-dev      \
        libreadline-dev \
        gperf           \
        libdb-dev       \
        libdb++-dev     \
        db-util         \
        m4              \
        cmake           \
        libtool         \
        perl            \
        klayout         \
        iverilog        \
        binutils-riscv64-unknown-elf \
        gcc-riscv64-linux-gnu        \
        g++-riscv64-linux-gnu        \
        ccache

    # install some binary standalone riscv toolchain
    XPACK_VERSION=14.2.0-3
    wget https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack/releases/download/v${XPACK_VERSION}/xpack-riscv-none-elf-gcc-${XPACK_VERSION}-linux-x64.tar.gz
    mkdir -p /opt/riscv-none-elf-gcc
    tar -zxf ./xpack-riscv-none-elf-gcc-${XPACK_VERSION}-linux-x64.tar.gz -C /opt/riscv-none-elf-gcc --strip-components=1
    rm ./xpack-riscv-none-elf-gcc-${XPACK_VERSION}-linux-x64.tar.gz

    # prepare to install PDKs into this container
    python3 -m venv /tmp/venv
    . /tmp/venv/bin/activate
    pip3 install --upgrade --no-cache-dir volare==0.20.6
    mkdir -p /usr/local/share/pdk

    # install sky130 pdk
    volare fetch --pdk-root=/usr/local/share/pdk --pdk="sky130" bdc9412b3e468c102d01b7cf6337be06ec6e9c9a

    # install IHP PDK of some special version
    volare build --pdk-root=/usr/local/share/pdk --pdk="ihp_sg13g2" 68eebafcd9b2f5e92c69d37a8d3d90eb266550f5

    # leave volare venv
    deactivate
    rm -rf /tmp/venv # technically not needed

    # pull openlane1 container
    apptainer pull /openlane.img docker://efabless/openlane:2024.09.19

    # pull openlane2 container
    apptainer pull /openlane2.img docker://ghcr.io/efabless/openlane2:2.3.10

    # convert gdhl container
    apptainer pull /ghdl.img docker://ghdl/ghdl:bookworm-mcode

    git clone --depth=2 -b v0.22.1-fix_verilator https://github.com/electronicvisions/spack /spack
    export SPACK_DISABLE_LOCAL_CONFIG=1
    export SPACK_USER_CONFIG_PATH=/dev/null
    /spack/bin/spack config add "packages:all:target:[x86_64]"
    /spack/bin/spack config add "modules:prefix_inspections:lib64:[LD_LIBRARY_PATH]"
    /spack/bin/spack config add "modules:prefix_inspections:lib:[LD_LIBRARY_PATH]"
    /spack/bin/spack bootstrap root /spack/bootstrap
    /spack/bin/spack compiler find
    /spack/bin/spack compilers
    find /spack/etc
    /spack/bin/spack bootstrap now
    /spack/bin/spack bootstrap status || true # TODO: delete
    /spack/bin/spack external find binutils
    /spack/bin/spack external find python
    /spack/bin/spack external find gmake
    /spack/bin/spack external find automake
    /spack/bin/spack external find autoconf
    /spack/bin/spack external find flex
    /spack/bin/spack external find bison
    /spack/bin/spack external find ccache
    /spack/bin/spack external find pkgconf
    /spack/bin/spack external find berkeley-db
    /spack/bin/spack external find m4
    /spack/bin/spack external find cmake
    /spack/bin/spack external find libtool
    /spack/bin/spack external find perl

    /spack/bin/spack find -l

    /spack/bin/spack repo add /spack_owas

    # define owas environmentberkeley-db
    /spack/bin/spack env create owas
    /spack/bin/spack -e owas add verilator
    # TODO: add ghdl, iverilog/icarus, cross compiler via spack
    /spack/bin/spack -e owas add py-spice ^ngspice+cider+openmp+osdi
    /spack/bin/spack -e owas concretize
    /spack/bin/spack -e owas fetch
    /spack/bin/spack -e owas install -v -j $(( $(nproc) / 2 ))

    # create env script
    . /spack/share/spack/setup-env.sh
    spack env activate owas --sh > /spack_owas.sh

%environment
    export SPACK_DISABLE_LOCAL_CONFIG=1
    export SPACK_USER_CONFIG_PATH=/dev/null
    . /spack_owas.sh
    export PATH=/opt/riscv-none-elf-gcc/bin:$PATH

# Building an librelane container
# ubuntu:22.04 maximises nix package cache hits
Bootstrap: docker
From: ubuntu:22.04

%setup
    mkdir ${APPTAINER_ROOTFS}/nix_build_cache
    mkdir ${APPTAINER_ROOTFS}/usr/local/share/pdk

%post -c /bin/bash
    apt-get update -y
    apt-get install -o DPkg::Options::=--force-confold -y -q --reinstall \
        curl xz-utils git manpages
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # single-user nix install
    install -d -m777 -o $(id -u) -g $(id -g) /nix
    export HOME=/
    curl -L https://nixos.org/nix/install > nix-install
    chmod +x ./nix-install
    mkdir /etc/nix
    echo "build-users-group =" > /etc/nix/nix.conf
    echo "download-buffer-size = 1073741824" >> /etc/nix/nix.conf
    echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
    echo "substituters = file:///nix_build_cache?trusted=1 https://cache.nixos.org https://nix-cache.fossi-foundation.org" >> /etc/nix/nix.conf
    echo "trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-cache.fossi-foundation.org:3+K59iFwXqKsL7BNu6Guy0v+uTlwsxYQxjspXzqLYQs=" >> /etc/nix/nix.conf
    ./nix-install --no-daemon --yes --no-modify-profile
    rm ./nix-install
    export USER=root
    . $HOME/.nix-profile/etc/profile.d/nix.sh

    # now provide librelane (officially recommended way)
    LIBRELANE_VERSION="ihp" # moving branch, no tags yet
    NIX_URL="github:librelane/librelane/${LIBRELANE_VERSION}#devShells.x86_64-linux.default"
    nix build ${NIX_URL}
    if [[ "$APPTAINER_BIND" == *"/nix_build_cache"* ]]; then
        nix copy --to file:///nix_build_cache ${NIX_URL}
    fi

    chmod 666 /nix/var/nix/db/big-lock
    chmod 777 /nix/var/nix/db
    chmod 777 /nix/var/nix/temproots/
    git config --global --add safe.directory /librelane

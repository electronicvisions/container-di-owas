# Building an librelane container
# ubuntu:22.04 maximises nix package cache hits
Bootstrap: docker
From: ubuntu:22.04

%post
    apt-get update -y
    apt-get install -o DPkg::Options::=--force-confold -y -q --reinstall \
        curl xz-utils git manpages
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # single-user nix install
    install -d -m777 -o $(id -u) -g $(id -g) /nix
    export HOME=/
    curl -L https://nixos.org/nix/install > nix-install
    chmod +x ./nix-install
    mkdir /etc/nix
    echo "build-users-group =" > /etc/nix/nix.conf
    ./nix-install --no-daemon --yes --no-modify-profile
    rm ./nix-install
    export USER=root
    . $HOME/.nix-profile/etc/profile.d/nix.sh

    # now provide librelane (officially recommended way)
    LIBRELANE_VERSION="2.4.0.dev10"
    git clone https://github.com/librelane/librelane -b ${LIBRELANE_VERSION} /librelane
    cd /librelane
    nix-shell --run 'exit'

    chmod 666 /nix/var/nix/db/big-lock
    chmod 777 /nix/var/nix/db
    chmod 777 /nix/var/nix/temproots/
    git config --global --add safe.directory /librelane
